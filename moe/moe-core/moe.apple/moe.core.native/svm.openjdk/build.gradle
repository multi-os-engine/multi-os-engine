import org.moe.prebuilts.XcodeBuild
import org.moe.prebuilts.Script

task('jdk_gensrc', type: Script) {
    progress 'Fetching boot JDK'
    rawWorkDir external.svm.mx
    def bootJDK = file("${external.svm.root}/bootJDK").absolutePath
    exec 'arch', '-x86_64', './mx',
            '-y', '--no-warning',
            'fetch-jdk',
            '--java-distribution', 'labsjdk-ce-11',
            '--to', bootJDK,
            '--alias', 'jdk11'

    progress 'Configure'
    rawWorkDir external.svm.openjdk
    exec 'arch', '-x86_64', 'python', './build_labsjdk.py',
            '--configure-only',
            '--boot-jdk', file(bootJDK + '/jdk11/Contents/Home').absolutePath

    progress 'Gensrc'
    exec 'arch', '-x86_64', 'make',
            'java.base-libs', 'jdk.crypto.ec-libs'
}

XcodeBuild.createTask(project, "libjava", "ios", "iphoneos", "Debug")
        .cond_buildopt(buildfilter.ios.archs, "ARCHS")
        .cond_buildopt(buildfilter.ios.archs != null, "ONLY_ACTIVE_ARCH", "YES")
        .dependsOn('jdk_gensrc')
XcodeBuild.createTask(project, "libjava", "ios", "iphoneos", "Release")
        .cond_buildopt(buildfilter.ios.archs, "ARCHS")
        .cond_buildopt(buildfilter.ios.archs != null, "ONLY_ACTIVE_ARCH", "YES")
        .dependsOn('jdk_gensrc')
XcodeBuild.createTask(project, "libjava", "ios", "iphonesimulator", "Debug")
        .cond_buildopt(buildfilter.ios.archs, "ARCHS")
        .cond_buildopt(buildfilter.ios.archs != null, "ONLY_ACTIVE_ARCH", "YES")
        .dependsOn('jdk_gensrc')
XcodeBuild.createTask(project, "libjava", "ios", "iphonesimulator", "Release")
        .cond_buildopt(buildfilter.ios.archs, "ARCHS")
        .cond_buildopt(buildfilter.ios.archs != null, "ONLY_ACTIVE_ARCH", "YES")
        .dependsOn('jdk_gensrc')
